{% extends "base.html" %}
{% load humanize %}
{% load static %}

{% block title %}Storage Explorer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/databases.css' %}">
<link rel="stylesheet" href="{% static 'css/storage.css' %}">
{% endblock %}

{% block content %}
<div class="storage-container">
  <h2>Storage Explorer</h2>
  
  <!-- Server Summary Section -->
  <div class="server-summary-section">
    <h3>Data Drive Summary (Drives with Disk Numbers Only)</h3>
    
    <!-- Overall Summary Bar -->
    <div class="summary-bar overall">
      <div class="summary-header">
        <h4>Total Data Storage</h4>
        <div class="summary-stats-inline">
          <span class="stat-item">{{ server_summary.total_drives }} drives</span>
          <span class="stat-item">{{ server_summary.total_capacity_tb }} TB total</span>
          <span class="stat-item">{{ server_summary.total_used_tb }} TB used</span>
          <span class="stat-item">{{ server_summary.total_free_tb }} TB free</span>
          {% if server_summary.failing_drives_count > 0 %}
          <span class="stat-item failing">{{ server_summary.failing_drives_count }} failing</span>
          {% endif %}
        </div>
      </div>
      <div class="summary-progress-large">
        <div class="progress-bar-large">
          <div class="progress-fill-large overall" style="width: {{ server_summary.overall_utilization }}%"></div>
        </div>
        <div class="progress-info">
          <span class="progress-text-large">{{ server_summary.overall_utilization }}% used</span>
          <span class="progress-capacity">{{ server_summary.total_used_tb }} / {{ server_summary.total_capacity_tb }} TB</span>
        </div>
      </div>
    </div>

    <!-- Drive Type Breakdown -->
    <div class="summary-row">
      {% if server_summary.cmr_data.count > 0 %}
      <div class="summary-item cmr">
        <div class="summary-label">
          <h5>CMR Drives</h5>
          <div class="summary-details">
            <span>{{ server_summary.cmr_data.count }} drives</span>
            <span>{{ server_summary.cmr_data.capacity }} TB</span>
          </div>
        </div>
        <div class="summary-progress">
          <div class="progress-bar">
            <div class="progress-fill cmr" style="width: {{ server_summary.cmr_data.utilization }}%"></div>
          </div>
          <div class="progress-text">{{ server_summary.cmr_data.utilization }}% ({{ server_summary.cmr_data.used }} TB)</div>
        </div>
      </div>
      {% endif %}

      {% if server_summary.smr_data.count > 0 %}
      <div class="summary-item smr">
        <div class="summary-label">
          <h5>SMR Drives</h5>
          <div class="summary-details">
            <span>{{ server_summary.smr_data.count }} drives</span>
            <span>{{ server_summary.smr_data.capacity }} TB</span>
          </div>
        </div>
        <div class="summary-progress">
          <div class="progress-bar">
            <div class="progress-fill smr" style="width: {{ server_summary.smr_data.utilization }}%"></div>
          </div>
          <div class="progress-text">{{ server_summary.smr_data.utilization }}% ({{ server_summary.smr_data.used }} TB)</div>
        </div>
      </div>
      {% endif %}

      {% if server_summary.storage_types %}
      {% for storage_type, data in server_summary.storage_types.items %}
      <div class="summary-item {{ storage_type|lower }}">
        <div class="summary-label">
          <h5>{{ storage_type }} Drives</h5>
          <div class="summary-details">
            <span>{{ data.count }} drives</span>
            <span>{{ data.capacity|floatformat:1 }} TB</span>
          </div>
        </div>
        <div class="summary-progress">
          <div class="progress-bar">
            <div class="progress-fill {{ storage_type|lower }}" style="width: {{ data.utilization }}%"></div>
          </div>
          <div class="progress-text">{{ data.utilization|floatformat:1 }}% ({{ data.used|floatformat:1 }} TB)</div>
        </div>
      </div>
      {% endfor %}
      {% endif %}
    </div>
  </div>
  
  <div class="add-storage-section">
    <button id="toggle-add-form" class="add-button">Add New Drive</button>
    
    <div id="add-storage-form" class="storage-form-container" style="display: none;">
      <h3>Add Storage Device</h3>
      <form method="post" action="{% url 'storage_view' %}">
    {% csrf_token %}
    <div class="form-grid">
        <div class="form-group">
            <label for="model">Model:</label>
            <input type="text" id="model" name="model" required>
        </div>
        
        <div class="form-group">
            <label for="serial_number">Serial Number:</label>
            <input type="text" id="serial_number" name="serial_number">
        </div>

        <div class="form-group">
            <label for="storage_type">Type:</label>
            <select id="storage_type" name="storage_type">
                <option value="HDD">HDD</option>
                <option value="SSD">SSD</option>
                <option value="NVMe">NVMe</option>
                <option value="Other">Other</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="storage_sub_type">Sub Type:</label>
            <input type="text" id="storage_sub_type" name="storage_sub_type">
        </div>
        
        <div class="form-group">
            <label for="capacity_tb">Capacity (TB):</label>
            <input type="number" id="capacity_tb" name="capacity_tb" step="0.1" required>
        </div>

        <div class="form-group">
            <label for="disk_location">Disk Location:</label>
            <input type="number" id="disk_location" name="disk_location" min="0">
        </div>
        
        <div class="form-group">
            <label for="rpm">RPM:</label>
            <input type="number" id="rpm" name="rpm">
        </div>

        <div class="form-group">
            <label for="utilisation">Utilisation (%):</label>
            <input type="number" id="utilisation" name="utilisation" step="0.01" min="0" max="100" value="0">
        </div>

        <div class="form-group">
            <label for="fragmentation">Fragmentation (%):</label>
            <input type="number" id="fragmentation" name="fragmentation" step="0.01" min="0" max="100">
        </div>

        <div class="form-group">
            <label for="actual_fragmentation">Actual Fragmentation:</label>
            <input type="number" id="actual_fragmentation" name="actual_fragmentation">
        </div>

        <div class="form-group">
            <label for="ideal_fragmentation">Ideal Fragmentation:</label>
            <input type="number" id="ideal_fragmentation" name="ideal_fragmentation">
        </div>
        
        <div class="form-group full-width">
            <label for="system">Assign to System:</label>
            <select id="system" name="system">
                <option value="">-- None (Miscellaneous) --</option>
                {% for system in systems %}
                    <option value="{{ system.id }}">{{ system.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    
    <div class="form-buttons">
        <button type="submit" class="submit-btn">Save Drive</button>
        <button type="button" id="cancel-add" class="cancel-btn">Cancel</button>
    </div>
</form>
    </div>
  </div>

<div class="storage-section">
  {% if systems_with_drives %}
    <h3>Systems</h3>
    {% for item in systems_with_drives %}
      <div class="system-card">
        <div class="system-header expandable" data-system-id="{{ item.system.id }}">
          <span class="system-name">{{ item.system.name }}</span>
          <span class="system-info">{{ item.system.location.rack }} | {{ item.drives|length }} drives</span>
          <span class="expand-icon">â–¼</span>
        </div>
        <div class="system-drives-container" id="system-drives-{{ item.system.id }}">
          {% if item.drives %}
            <table class="drives-table">
            <thead>
              <tr>
                <th>Disk#</th>
                <th>Model</th>
                <th>Serial</th>
                <th>Type</th>
                <th>Sub Type</th>
                <th>Capacity</th>
                <th>RPM</th>
                <th>Utilization</th>
                <th>Frag %</th>
                <th>Actual Frag</th>
                <th>Ideal Frag</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
                {% for drive in item.drives %}
                  <tr class="drive-row {% if drive.failure %}failing-drive{% endif %}">
                    <td>
                      {% if drive.disk_display_value.class %}
                        <span class="disk-badge {{ drive.disk_display_value.class }}">{{ drive.disk_display_value.text }}</span>
                      {% else %}
                        {{ drive.disk_display_value.text }}
                      {% endif %}
                    </td>
                    <td>{{ drive.model }}</td>
                    <td>{{ drive.serial_number|default:"N/A" }}</td>
                    <td>{{ drive.storage_type }}</td>
                    <td>{{ drive.storage_sub_type|default:"-" }}</td>
                    <td>{{ drive.capacity_tb }} TB</td>
                    <td>{{ drive.rpm|default:"N/A" }}</td>
                    <td class="utilization-cell">
                      <div class="utilization-container">
                        <div class="utilization-bar">
                          <div class="utilization-fill" style="width: {{ drive.utilisation }}%"></div>
                        </div>
                        <span class="utilization-text">{{ drive.utilisation }}%</span>
                      </div>
                    </td>
                    <td>{{ drive.calculated_fragmentation|default:"-" }}%</td>
                    <td>{{ drive.actual_fragmentation|default:"-" }}</td>
                    <td>{{ drive.ideal_fragmentation|default:"-" }}</td>
                    <td class="actions-cell">
                      <a href="{% url 'edit_storage' drive.id %}" class="edit-btn">Edit</a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
          </table>
          {% else %}
            <p class="no-drives">No drives assigned to this system</p>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p>No systems found.</p>
  {% endif %}
</div>

  <div class="storage-section">
    <h3>Miscellaneous Drives</h3>
    {% if misc_drives %}
      <table class="drives-table">
        <thead>
          <tr>
            <th>Model</th>
            <th>Serial</th>
            <th>Type</th>
            <th>Sub Type</th>
            <th>Capacity</th>
            <th>RPM</th>
            <th>Utilization</th>
            <th>Frag %</th>
            <th>Actual Frag</th>
            <th>Ideal Frag</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for drive in misc_drives %}
            <tr class="drive-row {% if drive.failure %}failing-drive{% endif %}">
              <td>{{ drive.model }}</td>
              <td>{{ drive.serial_number|default:"N/A" }}</td>
              <td>{{ drive.storage_type }}</td>
              <td>{{ drive.storage_sub_type|default:"-" }}</td>
              <td>{{ drive.capacity_tb }} TB</td>
              <td>{{ drive.rpm|default:"N/A" }}</td>
              <td class="utilization-cell">
                <div class="utilization-container">
                  <div class="utilization-bar">
                    <div class="utilization-fill" style="width: {{ drive.utilisation }}%"></div>
                  </div>
                  <span class="utilization-text">{{ drive.utilisation }}%</span>
                </div>
              </td>
              <td>{{ drive.calculated_fragmentation|default:"-" }}%</td>
              <td>{{ drive.actual_fragmentation|default:"-" }}</td>
              <td>{{ drive.ideal_fragmentation|default:"-" }}</td>
              <td class="actions-cell">
                <a href="{% url 'edit_storage' drive.id %}" class="edit-btn">Edit</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="no-drives">No miscellaneous drives found</p>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Toggle add form
    const toggleButton = document.getElementById('toggle-add-form');
    const addForm = document.getElementById('add-storage-form');
    const cancelButton = document.getElementById('cancel-add');
    
    toggleButton.addEventListener('click', function() {
      if (addForm.style.display === 'none') {
        addForm.style.display = 'block';
        toggleButton.textContent = 'Cancel';
      } else {
        addForm.style.display = 'none';
        toggleButton.textContent = 'Add New Drive';
      }
    });
    
    cancelButton.addEventListener('click', function() {
      addForm.style.display = 'none';
      toggleButton.textContent = 'Add New Drive';
    });
    
    // Expandable systems
    document.querySelectorAll('.system-header.expandable').forEach(header => {
      header.addEventListener('click', function() {
        const systemId = this.getAttribute('data-system-id');
        const drivesContainer = document.getElementById(`system-drives-${systemId}`);
        const expandIcon = this.querySelector('.expand-icon');
        
        if (drivesContainer.style.display === 'none') {
          drivesContainer.style.display = 'block';
          expandIcon.textContent = 'â–¼';
          this.classList.remove('collapsed');
        } else {
          drivesContainer.style.display = 'none';
          expandIcon.textContent = 'â–º';
          this.classList.add('collapsed');
        }
      });
    });
  });
</script>
{% endblock %}