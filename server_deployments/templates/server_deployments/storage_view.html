{% extends "base.html" %}
{% load humanize %}
{% load static %}

{% block title %}Storage Explorer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/databases.css' %}">
<link rel="stylesheet" href="{% static 'css/storage.css' %}">
{% endblock %}

{% block content %}
<div class="storage-container">
	<h2>Storage Explorer</h2>
	
	<!-- Server Summary Section -->
	<div class="server-summary-section">
		<h3>Data Drive Summary (Drives with Disk Numbers Only)</h3>
		
		<!-- Drive Type Breakdown -->
		<div class="summary-row">
			<!-- Overall Summary Item -->
			<div class="summary-item overall">
				<div class="summary-label">
					<h5>Total Data Storage</h5>
					<div class="summary-details">
						<span>{{ server_summary.total_drives }} drives</span>
						<span>{{ server_summary.total_used_tb }} / {{ server_summary.total_capacity_tb }} TB</span>
						<span>{{ server_summary.total_free_tb }} TB free</span>
						{% if server_summary.failing_drives_count > 0 %}
						<span class="failing">{{ server_summary.failing_drives_count }} failing</span>
						{% endif %}
					</div>
				</div>
				<div class="summary-progress">
					<div class="progress-bar">
						<div class="progress-fill overall" style="width: {{ server_summary.overall_utilization }}%"></div>
					</div>
					<div class="progress-text">{{ server_summary.overall_utilization }}%</div>
				</div>
			</div>

			{% if server_summary.cmr_data.count > 0 %}
			<div class="summary-item cmr">
				<div class="summary-label">
					<h5>CMR Drives</h5>
					<div class="summary-details">
						<span>{{ server_summary.cmr_data.count }} drives</span>
						<span>{{ server_summary.cmr_data.used }} / {{ server_summary.cmr_data.capacity }} TB</span>
						<span>{{ server_summary.cmr_data.free }} TB free</span>
					</div>
				</div>
				<div class="summary-progress">
					<div class="progress-bar">
						<div class="progress-fill cmr" style="width: {{ server_summary.cmr_data.utilization }}%"></div>
					</div>
					<div class="progress-text">{{ server_summary.cmr_data.utilization }}%</div>
				</div>
			</div>
			{% endif %}

			{% if server_summary.smr_data.count > 0 %}
			<div class="summary-item smr">
				<div class="summary-label">
					<h5>SMR Drives</h5>
					<div class="summary-details">
						<span>{{ server_summary.smr_data.count }} drives</span>
						<span>{{ server_summary.smr_data.used }} / {{ server_summary.smr_data.capacity }} TB</span>
						<span>{{ server_summary.smr_data.free }} TB free</span>
					</div>
				</div>
				<div class="summary-progress">
					<div class="progress-bar">
						<div class="progress-fill smr" style="width: {{ server_summary.smr_data.utilization }}%"></div>
					</div>
					<div class="progress-text">{{ server_summary.smr_data.utilization }}%</div>
				</div>
			</div>
			{% endif %}

			{% if server_summary.storage_types %}
			{% for storage_type, data in server_summary.storage_types.items %}
			<div class="summary-item {{ storage_type|lower }}">
				<div class="summary-label">
					<h5>{{ storage_type }} Drives</h5>
					<div class="summary-details">
						<span>{{ data.count }} drives</span>
						<span>{{ data.used|floatformat:1 }} / {{ data.capacity|floatformat:1 }} TB</span>
						<span>{{ data.free|floatformat:1 }} TB free</span>
					</div>
				</div>
				<div class="summary-progress">
					<div class="progress-bar">
						<div class="progress-fill {{ storage_type|lower }}" style="width: {{ data.utilization }}%"></div>
					</div>
					<div class="progress-text">{{ data.utilization|floatformat:1 }}%</div>
				</div>
			</div>
			{% endfor %}
			{% endif %}
		</div>
	</div>
	
	<div class="add-storage-section">
		<button id="toggle-add-form" class="add-button">Add New Drive</button>
		
		<div id="add-storage-form" class="storage-form-container" style="display: none;">
			<h3>Add Storage Device</h3>
			<form method="post" action="{% url 'storage_view' %}">
		{% csrf_token %}
		<div class="form-grid">
				<div class="form-group">
						<label for="model">Model:</label>
						<input type="text" id="model" name="model" required>
				</div>
				
				<div class="form-group">
						<label for="serial_number">Serial Number:</label>
						<input type="text" id="serial_number" name="serial_number">
				</div>

				<div class="form-group">
						<label for="storage_type">Type:</label>
						<select id="storage_type" name="storage_type">
								<option value="HDD">HDD</option>
								<option value="SSD">SSD</option>
								<option value="NVMe">NVMe</option>
								<option value="Other">Other</option>
						</select>
				</div>
				
				<div class="form-group">
						<label for="storage_sub_type">Sub Type:</label>
						<input type="text" id="storage_sub_type" name="storage_sub_type">
				</div>
				
				<div class="form-group">
						<label for="capacity_tb">Capacity (TB):</label>
						<input type="number" id="capacity_tb" name="capacity_tb" step="0.1" required>
				</div>

				<div class="form-group">
						<label for="disk_number">Disk Number:</label>
						<input type="number" id="disk_number" name="disk_number" min="0">
				</div>

				<div class="form-group">
					<label for="disk_position">Disk Position:</label>
					<input type="number" id="disk_position" name="disk_position" min="1" max="24">
				</div>
				
				<div class="form-group">
					<label for="rpm">RPM:</label>
					<input type="number" id="rpm" name="rpm">
				</div>

				<div class="form-group">
						<label for="utilisation">Utilisation (%):</label>
						<input type="number" id="utilisation" name="utilisation" step="0.01" min="0" max="100" value="0">
				</div>

				<div class="form-group">
						<label for="free_space_gb">Free Space (GB):</label>
						<input type="number" id="free_space_gb" name="free_space_gb" min="0">
				</div>

				<div class="form-group">
						<label for="fragmentation">Fragmentation (%):</label>
						<input type="number" id="fragmentation" name="fragmentation" step="0.01" min="0" max="100">
				</div>

				<div class="form-group">
						<label for="actual_fragmentation">Actual Fragmentation:</label>
						<input type="number" id="actual_fragmentation" name="actual_fragmentation">
				</div>

				<div class="form-group">
						<label for="ideal_fragmentation">Ideal Fragmentation:</label>
						<input type="number" id="ideal_fragmentation" name="ideal_fragmentation">
				</div>
				
				<div class="form-group full-width">
					<label for="system">Assign to System:</label>
					<select id="system" name="system">
							<option value="">-- None (Miscellaneous) --</option>
							{% for system in systems %}
									<option value="{{ system.id }}">{{ system.name }}</option>
							{% endfor %}
					</select>
				</div>
		</div>
		
		<div class="form-buttons">
				<button type="submit" class="submit-btn">Save Drive</button>
				<button type="button" id="cancel-add" class="cancel-btn">Cancel</button>
		</div>
</form>
		</div>
	</div>

<div class="storage-section">
	{% if systems_with_drives %}
		<h3>Systems</h3>
		{% for item in systems_with_drives %}
			<div class="system-card">
			<div class="system-header expandable" data-system-id="{{ item.system.id }}">
				<span class="system-name">{{ item.system.name }}</span>
				<span class="system-info">{{ item.system.location.rack }} | {{ item.drives|length }} drives</span>
				{% if item.system.name == 'Plex' %}
				<button class="location-btn" data-system-id="{{ item.system.id }}">View Locations</button>
				{% endif %}
				<span class="expand-icon">▼</span>
			</div>
				<div class="system-drives-container" id="system-drives-{{ item.system.id }}">
					{% if item.drives %}
						<table class="drives-table">
						<thead>
							<tr>
								<th>Disk#</th>
								<th>Model</th>
								<th>Serial</th>
								<th>Type</th>
								<th>Sub Type</th>
								<th>Capacity</th>
								<th>Free Space</th>
								<th>RPM</th>
								<th>Utilization</th>
								<th>Frag %</th>
								<th>Frag Diff</th>
								<th>Last Updated</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
								{% for drive in item.drives %}
									<tr class="drive-row {% if drive.failure %}failing-drive{% endif %} {% if drive.storage_sub_type|lower == 'cmr' %}cmr-drive{% elif drive.storage_sub_type|lower == 'smr' %}smr-drive{% endif %}">
										<td>
											{% if drive.disk_display_value.class %}
												<span class="disk-badge {{ drive.disk_display_value.class }}">{{ drive.disk_display_value.text }}</span>
											{% else %}
												{{ drive.disk_display_value.text }}
											{% endif %}
										</td>
										<td>{{ drive.model }}</td>
										<td>{{ drive.serial_number|default:"N/A" }}</td>
										<td>{{ drive.storage_type }}</td>
										<td>{{ drive.storage_sub_type|default:"-" }}</td>
										<td>{{ drive.capacity_tb }} TB</td>
										<td>{{ drive.free_space_gb|default:"-" }} GB</td>
										<td>{{ drive.rpm|default:"N/A" }}</td>
										<td class="utilization-cell">
											<div class="utilization-container">
												<div class="utilization-bar">
													<div class="utilization-fill" style="width: {{ drive.utilisation }}%"></div>
												</div>
												<span class="utilization-text">{{ drive.utilisation }}%</span>
											</div>
										</td>
										<td>{{ drive.calculated_fragmentation|default:"-" }}%</td>
										<td>{% if drive.fragmentation_difference is not None %}{{ drive.fragmentation_difference }}{% else %}-{% endif %}</td>
										<td>{% if drive.fragmentation_last_updated %}{{ drive.fragmentation_last_updated|date:"M d, Y" }}{% else %}-{% endif %}</td>
										<td class="actions-cell">
											<button type="button" class="edit-btn" data-drive-id="{{ drive.id }}">Edit</button>
										</td>
									</tr>
								{% endfor %}
							</tbody>
					</table>
					{% else %}
						<p class="no-drives">No drives assigned to this system</p>
					{% endif %}
				</div>
			</div>
			{% if item.system.name == 'Plex' %}
			<script id="drives-{{ item.system.id }}" type="application/json">
				[{% for drive in item.drives %}
					{
						"id": {{ drive.id }},
						"model": "{{ drive.model|escapejs }}",
						"serial_number": "{{ drive.serial_number|default:''|escapejs }}",
						"storage_type": "{{ drive.storage_type|escapejs }}",
						"capacity_tb": {{ drive.capacity_tb }},
						"utilisation": {{ drive.utilisation }},
						"disk_number": {{ drive.disk_number|default:"null" }},
						"disk_position": {{ drive.disk_position|default:"null" }},
						"failure": {{ drive.failure|lower }},
						"parity": {{ drive.parity|lower }}
					}{% if not forloop.last %},{% endif %}
				{% endfor %}]
			</script>
			<div class="modal" id="location-modal-{{ item.system.id }}">
				<div class="modal-content">
					<span class="close" data-system-id="{{ item.system.id }}">&times;</span>
					<h3>Drive Locations for {{ item.system.name }}</h3>
					<div class="location-grid">
						{% for char in '123456789012345678901234' %}
						<div class="location-box empty" data-location="{{ forloop.counter }}">
							<div class="position">{{ forloop.counter }}</div>
							<div class="size">-</div>
						</div>
						{% endfor %}
					</div>
					<div class="drive-info" id="drive-info-{{ item.system.id }}"></div>
				</div>
			</div>
			{% endif %}
		{% endfor %}
	{% else %}
		<p>No systems found.</p>
	{% endif %}
</div>

	<div class="storage-section">
		<h3>Miscellaneous Drives</h3>
		{% if misc_drives %}
			<table class="drives-table">
				<thead>
					<tr>
						<th>Model</th>
						<th>Serial</th>
						<th>Type</th>
						<th>Sub Type</th>
						<th>Capacity</th>
						<th>Free Space</th>
						<th>RPM</th>
						<th>Utilization</th>
						<th>Frag %</th>
						<th>Frag Diff</th>
						<th>Updated</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody>
					{% for drive in misc_drives %}
						<tr class="drive-row {% if drive.failure %}failing-drive{% endif %} {% if drive.storage_sub_type|lower == 'cmr' %}cmr-drive{% elif drive.storage_sub_type|lower == 'smr' %}smr-drive{% endif %}">
							<td>{{ drive.model }}</td>
							<td>{{ drive.serial_number|default:"N/A" }}</td>
							<td>{{ drive.storage_type }}</td>
							<td>{{ drive.storage_sub_type|default:"-" }}</td>
							<td>{{ drive.capacity_tb }} TB</td>
							<td>{{ drive.free_space_gb|default:"-" }} GB</td>
							<td>{{ drive.rpm|default:"N/A" }}</td>
							<td class="utilization-cell">
								<div class="utilization-container">
									<div class="utilization-bar">
										<div class="utilization-fill" style="width: {{ drive.utilisation }}%"></div>
									</div>
									<span class="utilization-text">{{ drive.utilisation }}%</span>
								</div>
							</td>
							<td>{{ drive.calculated_fragmentation|default:"-" }}%</td>
							<td>{% if drive.fragmentation_difference is not None %}{{ drive.fragmentation_difference }}{% else %}-{% endif %}</td>
							<td>{% if drive.fragmentation_last_updated %}{{ drive.fragmentation_last_updated|date:"M d, Y" }}{% else %}-{% endif %}</td>
							<td class="actions-cell">
								<button type="button" class="edit-btn" data-drive-id="{{ drive.id }}">Edit</button>
							</td>
						</tr>
					{% endfor %}
				</tbody>
			</table>
		{% else %}
			<p class="no-drives">No miscellaneous drives found</p>
		{% endif %}
	</div>
</div>

<!-- Edit Storage Modal -->
<div id="edit-storage-modal" class="modal">
	<div class="modal-content edit-modal">
		<span class="close" id="edit-modal-close">&times;</span>
		<h3>Edit Storage Device</h3>
		<form id="edit-storage-form" method="post">
			{% csrf_token %}
			<div class="form-grid">
				<div class="form-group">
					<label for="edit-model">Model:</label>
					<input type="text" id="edit-model" name="model" required>
				</div>

				<div class="form-group">
					<label for="edit-serial_number">Serial Number:</label>
					<input type="text" id="edit-serial_number" name="serial_number">
				</div>

				<div class="form-group">
					<label for="edit-storage_type">Type:</label>
					<select id="edit-storage_type" name="storage_type">
						<option value="HDD">HDD</option>
						<option value="SSD">SSD</option>
						<option value="NVMe">NVMe</option>
					</select>
				</div>

				<div class="form-group">
					<label for="edit-storage_sub_type">Sub Type:</label>
					<input type="text" id="edit-storage_sub_type" name="storage_sub_type">
				</div>

				<div class="form-group">
					<label for="edit-capacity_tb">Capacity (TB):</label>
					<input type="number" id="edit-capacity_tb" name="capacity_tb" step="0.1" required>
				</div>

				<div class="form-group">
					<label for="edit-disk_number">Disk Number:</label>
					<input type="number" id="edit-disk_number" name="disk_number" min="0">
				</div>

				<div class="form-group">
					<label for="edit-disk_position">Disk Position:</label>
					<input type="number" id="edit-disk_position" name="disk_position" min="1" max="24">
				</div>

				<div class="form-group">
					<label for="edit-rpm">RPM:</label>
					<input type="number" id="edit-rpm" name="rpm">
				</div>

				<div class="form-group">
					<label for="edit-utilisation">Utilisation (%):</label>
					<input type="number" id="edit-utilisation" name="utilisation" step="0.01" min="0" max="100">
				</div>

				<div class="form-group">
					<label for="edit-free_space_gb">Free Space (GB):</label>
					<input type="number" id="edit-free_space_gb" name="free_space_gb" min="0">
				</div>

				<div class="form-group">
					<label for="edit-fragmentation">Fragmentation (%):</label>
					<input type="number" id="edit-fragmentation" name="fragmentation" step="0.01" min="0" max="100">
				</div>

				<div class="form-group">
					<label for="edit-actual_fragmentation">Actual Fragmentation:</label>
					<input type="number" id="edit-actual_fragmentation" name="actual_fragmentation">
				</div>

				<div class="form-group">
					<label for="edit-ideal_fragmentation">Ideal Fragmentation:</label>
					<input type="number" id="edit-ideal_fragmentation" name="ideal_fragmentation">
				</div>

				<div class="form-group">
					<label for="edit-fragmentation_last_updated">Last Updated:</label>
					<input type="date" id="edit-fragmentation_last_updated" name="fragmentation_last_updated">
					<button type="button" id="set-today-btn" class="set-today-btn">Set to Today</button>
				</div>

				<div class="form-group">
					<label for="edit-cache">Cache Drive:</label>
					<input type="checkbox" id="edit-cache" name="cache">
				</div>

				<div class="form-group">
					<label for="edit-parity">Parity Drive:</label>
					<input type="checkbox" id="edit-parity" name="parity">
				</div>

				<div class="form-group">
					<label for="edit-failure">Failing Drive:</label>
					<input type="checkbox" id="edit-failure" name="failure">
				</div>

				<div class="form-group full-width">
					<label for="edit-system">Assign to System:</label>
					<select id="edit-system" name="system">
						<option value="">-- None (Miscellaneous) --</option>
						{% for system in systems %}
							<option value="{{ system.id }}">{{ system.name }}</option>
						{% endfor %}
					</select>
				</div>
			</div>

			<div class="form-buttons">
				<button type="submit" class="submit-btn">Save Changes</button>
				<button type="button" id="edit-cancel" class="cancel-btn">Cancel</button>
				<button type="button" id="edit-delete" class="delete-btn">Delete</button>
			</div>
		</form>
	</div>
</div>

<script>
	document.addEventListener('DOMContentLoaded', function() {
		// Toggle add form
		const toggleButton = document.getElementById('toggle-add-form');
		const addForm = document.getElementById('add-storage-form');
		const cancelButton = document.getElementById('cancel-add');
		
		if (toggleButton) {
			toggleButton.addEventListener('click', function() {
				if (addForm.style.display === 'none') {
					addForm.style.display = 'block';
					toggleButton.textContent = 'Cancel';
				} else {
					addForm.style.display = 'none';
					toggleButton.textContent = 'Add New Drive';
				}
			});
		}
		
		if (cancelButton) {
			cancelButton.addEventListener('click', function() {
				addForm.style.display = 'none';
				toggleButton.textContent = 'Add New Drive';
			});
		}
		
		// Expandable systems
		document.querySelectorAll('.system-header.expandable').forEach(header => {
			header.addEventListener('click', function() {
				const systemId = this.getAttribute('data-system-id');
				const drivesContainer = document.getElementById('system-drives-' + systemId);
				const expandIcon = this.querySelector('.expand-icon');
				
				if (drivesContainer.style.display === 'none') {
					drivesContainer.style.display = 'block';
					expandIcon.textContent = '▼';
					this.classList.remove('collapsed');
				} else {
					drivesContainer.style.display = 'none';
					expandIcon.textContent = '►';
					this.classList.add('collapsed');
				}
			});
		});

		// Location modal for Plex
		document.querySelectorAll('.location-btn').forEach(btn => {
			btn.addEventListener('click', function(e) {
				e.stopPropagation(); // Prevent header expansion
				const systemId = this.getAttribute('data-system-id');
				const modal = document.getElementById('location-modal-' + systemId);
				modal.style.display = 'block';
				
				// Load drives data
				const drivesScript = document.getElementById('drives-' + systemId);
				if (drivesScript) {
					const drives = JSON.parse(drivesScript.textContent);
					
					// Populate location boxes with drive information
					modal.querySelectorAll('.location-box').forEach(box => {
						const location = parseInt(box.dataset.location);
						const drive = drives.find(function(d) { return d.disk_position === location; });
						
						if (drive) {
							const positionDiv = box.querySelector('.position');
							const sizeDiv = box.querySelector('.size');
							
							positionDiv.textContent = location;
							sizeDiv.textContent = drive.capacity_tb + 'TB';
							
							// Add parity indicator if drive is parity
							if (drive.parity) {
								box.classList.add('parity');
							}
							
							// Add failure indicator if drive is failing
							if (drive.failure) {
								box.classList.add('failing');
							}
							
							// Remove empty class and add occupied class
							box.classList.remove('empty');
							box.classList.add('occupied');
							
							// Add size-based color class
							let sizeClass = '';
							if (drive.capacity_tb <= 4) {
								sizeClass = 'size-small';
							} else if (drive.capacity_tb <= 10) {
								sizeClass = 'size-medium';
							} else if (drive.capacity_tb <= 16) {
								sizeClass = 'size-large';
							} else {
								sizeClass = 'size-xl';
							}
							box.classList.add(sizeClass);
						} else {
							// Empty slot
							const positionDiv = box.querySelector('.position');
							const sizeDiv = box.querySelector('.size');
							
							positionDiv.textContent = location;
							sizeDiv.textContent = '-';
							
							box.classList.add('empty');
							box.classList.remove('occupied');
						}
					});
					
					// Add click handlers to location boxes
					modal.querySelectorAll('.location-box').forEach(box => {
						box.addEventListener('click', function() {
							const location = parseInt(this.dataset.location);
							const drive = drives.find(function(d) { return d.disk_position === location; });
							const infoDiv = document.getElementById('drive-info-' + systemId);
							
							if (drive) {
								infoDiv.innerHTML = '<strong>Drive Information:</strong><br>' +
									'Position: ' + drive.disk_position + '<br>' +
									'Size: ' + drive.capacity_tb + ' TB<br>' +
									'Model: ' + drive.model + '<br>' +
									'Serial: ' + (drive.serial_number || 'N/A') + '<br>' +
									'Type: ' + drive.storage_type + '<br>' +
									'Utilization: ' + drive.utilisation + '%<br>' +
									'Disk Number: ' + (drive.disk_number || 'N/A');
							} else {
								infoDiv.innerHTML = 'No drive assigned to this position.';
							}
						});
					});
				}
			});
		});

		// Close modals
		document.querySelectorAll('.close').forEach(closeBtn => {
			closeBtn.addEventListener('click', function() {
				const systemId = this.getAttribute('data-system-id');
				const modal = document.getElementById('location-modal-' + systemId);
				modal.style.display = 'none';
			});
		});

		// Close modal when clicking outside
		window.addEventListener('click', function(event) {
			if (event.target.classList.contains('modal')) {
				event.target.style.display = 'none';
			}
		});

		// Edit storage modal functionality
		const editModal = document.getElementById('edit-storage-modal');
		const editForm = document.getElementById('edit-storage-form');
		const editModalClose = document.getElementById('edit-modal-close');
		const editCancelBtn = document.getElementById('edit-cancel');
		const editDeleteBtn = document.getElementById('edit-delete');

		// Open edit modal
		document.querySelectorAll('.edit-btn').forEach(btn => {
			btn.addEventListener('click', function(e) {
				const driveId = this.getAttribute('data-drive-id');

				// Fetch drive data
				fetch('/storage/' + driveId + '/edit/', {
					headers: {
						'X-Requested-With': 'XMLHttpRequest'
					}
				})
					.then(function(response) {
						return response.json();
					})
					.then(function(data) {
						// Populate form fields
						document.getElementById('edit-model').value = data.model || '';
						document.getElementById('edit-serial_number').value = data.serial_number || '';
						document.getElementById('edit-storage_type').value = data.storage_type || '';
						document.getElementById('edit-storage_sub_type').value = data.storage_sub_type || '';
						document.getElementById('edit-capacity_tb').value = data.capacity_tb || '';
						document.getElementById('edit-disk_number').value = data.disk_number || '';
						document.getElementById('edit-disk_position').value = data.disk_position || '';
						document.getElementById('edit-rpm').value = data.rpm || '';
						document.getElementById('edit-utilisation').value = data.utilisation || '';
						document.getElementById('edit-free_space_gb').value = data.free_space_gb || '';
						document.getElementById('edit-fragmentation').value = data.fragmentation || '';
						document.getElementById('edit-actual_fragmentation').value = data.actual_fragmentation || '';
						document.getElementById('edit-ideal_fragmentation').value = data.ideal_fragmentation || '';
						document.getElementById('edit-fragmentation_last_updated').value = data.fragmentation_last_updated ? new Date(data.fragmentation_last_updated).toISOString().split('T')[0] : '';
						document.getElementById('edit-cache').checked = data.cache || false;
						document.getElementById('edit-parity').checked = data.parity || false;
						document.getElementById('edit-failure').checked = data.failure || false;
						document.getElementById('edit-system').value = data.system_id || '';

						// Update form action
						editForm.action = '/storage/' + driveId + '/edit/';

						// Show modal
						editModal.style.display = 'block';
					})
					.catch(function(error) {
						alert('Error loading drive data. Please try again.');
					});
			});
		});

		// Close edit modal
		editModalClose.addEventListener('click', function() {
			editModal.style.display = 'none';
		});

		editCancelBtn.addEventListener('click', function() {
			editModal.style.display = 'none';
		});

		// Handle set today button
		const setTodayBtn = document.getElementById('set-today-btn');
		setTodayBtn.addEventListener('click', function() {
			const today = new Date().toISOString().split('T')[0];
			document.getElementById('edit-fragmentation_last_updated').value = today;
		});

		// Handle bidirectional calculation between utilisation and free space
		const utilisationInput = document.getElementById('edit-utilisation');
		const freeSpaceInput = document.getElementById('edit-free_space_gb');
		const capacityInput = document.getElementById('edit-capacity_tb');

		function calculateFromUtilisation() {
			const utilisation = parseFloat(utilisationInput.value) || 0;
			const capacityTb = parseFloat(capacityInput.value) || 0;
			if (capacityTb > 0) {
				const totalGb = capacityTb * 1024;
				const usedGb = totalGb * (utilisation / 100);
				const freeGb = totalGb - usedGb;
				freeSpaceInput.value = Math.round(freeGb);
			}
		}

		function calculateFromFreeSpace() {
			const freeGb = parseFloat(freeSpaceInput.value) || 0;
			const capacityTb = parseFloat(capacityInput.value) || 0;
			if (capacityTb > 0) {
				const totalGb = capacityTb * 1024;
				if (totalGb > 0) {
					const usedGb = totalGb - freeGb;
					const utilisation = (usedGb / totalGb) * 100;
					utilisationInput.value = utilisation.toFixed(2);
				}
			}
		}

		utilisationInput.addEventListener('input', calculateFromUtilisation);
		freeSpaceInput.addEventListener('input', calculateFromFreeSpace);
		capacityInput.addEventListener('input', function() {
			// Recalculate when capacity changes
			if (utilisationInput.value) {
				calculateFromUtilisation();
			} else if (freeSpaceInput.value) {
				calculateFromFreeSpace();
			}
		});

		// Handle bidirectional calculation for add form
		const addUtilisationInput = document.getElementById('utilisation');
		const addFreeSpaceInput = document.getElementById('free_space_gb');
		const addCapacityInput = document.getElementById('capacity_tb');

		function addCalculateFromUtilisation() {
			const utilisation = parseFloat(addUtilisationInput.value) || 0;
			const capacityTb = parseFloat(addCapacityInput.value) || 0;
			if (capacityTb > 0) {
				const totalGb = capacityTb * 1024;
				const usedGb = totalGb * (utilisation / 100);
				const freeGb = totalGb - usedGb;
				addFreeSpaceInput.value = Math.round(freeGb);
			}
		}

		function addCalculateFromFreeSpace() {
			const freeGb = parseFloat(addFreeSpaceInput.value) || 0;
			const capacityTb = parseFloat(addCapacityInput.value) || 0;
			if (capacityTb > 0) {
				const totalGb = capacityTb * 1024;
				if (totalGb > 0) {
					const usedGb = totalGb - freeGb;
					const utilisation = (usedGb / totalGb) * 100;
					addUtilisationInput.value = utilisation.toFixed(2);
				}
			}
		}

		addUtilisationInput.addEventListener('input', addCalculateFromUtilisation);
		addFreeSpaceInput.addEventListener('input', addCalculateFromFreeSpace);
		addCapacityInput.addEventListener('input', function() {
			// Recalculate when capacity changes
			if (addUtilisationInput.value) {
				addCalculateFromUtilisation();
			} else if (addFreeSpaceInput.value) {
				addCalculateFromFreeSpace();
			}
		});

		// Handle form submission
		editForm.addEventListener('submit', function(e) {
			e.preventDefault();

			const formData = new FormData(editForm);

			fetch(editForm.action, {
				method: 'POST',
				body: formData,
				headers: {
					'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
					'X-Requested-With': 'XMLHttpRequest'
				}
			})
			.then(function(response) {
				if (response.ok) {
					editModal.style.display = 'none';
					location.reload(); // Refresh the page to show updated data
				} else {
					return response.text().then(function(text) {
						throw new Error(text);
					});
				}
			})
			.catch(function(error) {
				alert('Error saving drive. Please try again.');
			});
		});

		// Handle delete
		editDeleteBtn.addEventListener('click', function() {
			if (confirm('Are you sure you want to delete this drive?')) {
				const deleteUrl = editForm.action.replace('/edit/', '/delete/');
				fetch(deleteUrl, {
					method: 'POST',
					headers: {
						'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
						'X-Requested-With': 'XMLHttpRequest'
					}
				})
				.then(function(response) {
					if (response.ok) {
						editModal.style.display = 'none';
						location.reload();
					} else {
						alert('Error deleting drive. Please try again.');
					}
				})
				.catch(function(error) {
					alert('Error deleting drive. Please try again.');
				});
			}
		});
	});
</script>

{% endblock %}