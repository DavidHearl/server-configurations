{% extends 'base.html' %}
{% load static %}

{% block title %}{{ guide.title }} - Django Guides{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/django_guides.css' %}">
{% endblock %}

{% block content %}
<div class="django-guide-detail">
    <div class="guide-nav">
        <a href="{% url 'django_guides' %}" class="back-link">← All Guides</a>
        <div class="guide-nav-links">
            {% for g in all_guides %}
            <a href="{% url 'django_guide_detail' g.slug %}" class="{% if g.id == guide.id %}active{% endif %}">
                {{ g.title }}
            </a>
            {% endfor %}
        </div>
    </div>

    <div class="guide-header">
        <h1>{{ guide.title }}</h1>
        <p class="guide-description">{{ guide.description }}</p>
        <button onclick="showAddStepModal()" class="add-step-btn">+ Add Step</button>
    </div>

    <div class="steps-container" id="stepsContainer">
        {% for step in steps %}
        <div class="step-item" data-step-id="{{ step.id }}" data-order="{{ step.order }}">
            <div class="step-header">
                <div class="step-drag-handle">☰</div>
                <span class="step-type-badge {{ step.step_type }}">{{ step.get_step_type_display }}</span>
                <h3 class="step-title">{{ step.order }}. {{ step.title }}</h3>
                <div class="step-actions">
                    <button onclick="editStep({{ step.id }})" class="edit-btn">Edit</button>
                    <button onclick="deleteStep({{ step.id }})" class="delete-btn">Delete</button>
                </div>
            </div>
            <div class="step-content">
                {{ step.content|safe }}
            </div>
        </div>
        {% empty %}
        <div class="no-steps">
            <p>No steps yet. Click "Add Step" to get started.</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Add Step Modal -->
<div id="addStepModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAddStepModal()">&times;</span>
        <h2>Add New Step</h2>
        <form id="addStepForm" method="POST" action="{% url 'django_step_add' guide.slug %}">
            {% csrf_token %}
            <div class="form-group">
                <label for="step_title">Title:</label>
                <input type="text" id="step_title" name="title" required>
            </div>
            <div class="form-group">
                <label for="step_type">Type:</label>
                <select id="step_type" name="step_type">
                    <option value="section">Section</option>
                    <option value="command">Command</option>
                    <option value="code">Code Block</option>
                    <option value="note">Note</option>
                </select>
            </div>
            <div class="form-group">
                <label for="step_order">Order:</label>
                <input type="number" id="step_order" name="order" value="{{ steps|length|add:1 }}" required>
            </div>
            <div class="form-group">
                <label for="step_content">Content (HTML):</label>
                <textarea id="step_content" name="content" rows="10" required></textarea>
                <small>You can use HTML tags for formatting</small>
            </div>
            <div class="form-actions">
                <button type="submit" class="submit-btn">Add Step</button>
                <button type="button" onclick="closeAddStepModal()" class="cancel-btn">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Step Modal -->
<div id="editStepModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditStepModal()">&times;</span>
        <h2>Edit Step</h2>
        <form id="editStepForm" method="POST">
            {% csrf_token %}
            <input type="hidden" id="edit_step_id" name="step_id">
            <div class="form-group">
                <label for="edit_step_title">Title:</label>
                <input type="text" id="edit_step_title" name="title" required>
            </div>
            <div class="form-group">
                <label for="edit_step_type">Type:</label>
                <select id="edit_step_type" name="step_type">
                    <option value="section">Section</option>
                    <option value="command">Command</option>
                    <option value="code">Code Block</option>
                    <option value="note">Note</option>
                </select>
            </div>
            <div class="form-group">
                <label for="edit_step_order">Order:</label>
                <input type="number" id="edit_step_order" name="order" required>
            </div>
            <div class="form-group">
                <label for="edit_step_content">Content (HTML):</label>
                <textarea id="edit_step_content" name="content" rows="10" required></textarea>
                <small>You can use HTML tags for formatting</small>
            </div>
            <div class="form-actions">
                <button type="submit" class="submit-btn">Save Changes</button>
                <button type="button" onclick="closeEditStepModal()" class="cancel-btn">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
// Modal functions
function showAddStepModal() {
    document.getElementById('addStepModal').style.display = 'block';
}

function closeAddStepModal() {
    document.getElementById('addStepModal').style.display = 'none';
}

function closeEditStepModal() {
    document.getElementById('editStepModal').style.display = 'none';
}

// Edit step
function editStep(stepId) {
    fetch(`/django-guides/step/${stepId}/edit/`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('edit_step_id').value = data.id;
        document.getElementById('edit_step_title').value = data.title;
        document.getElementById('edit_step_type').value = data.step_type;
        document.getElementById('edit_step_order').value = data.order;
        document.getElementById('edit_step_content').value = data.content;
        document.getElementById('editStepForm').action = `/django-guides/step/${stepId}/edit/`;
        document.getElementById('editStepModal').style.display = 'block';
    });
}

// Delete step
function deleteStep(stepId) {
    if (confirm('Are you sure you want to delete this step?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/django-guides/step/${stepId}/delete/`;
        const csrf = document.createElement('input');
        csrf.type = 'hidden';
        csrf.name = 'csrfmiddlewaretoken';
        csrf.value = '{{ csrf_token }}';
        form.appendChild(csrf);
        document.body.appendChild(form);
        form.submit();
    }
}

// Close modals on outside click
window.onclick = function(event) {
    const addModal = document.getElementById('addStepModal');
    const editModal = document.getElementById('editStepModal');
    if (event.target == addModal) {
        addModal.style.display = 'none';
    }
    if (event.target == editModal) {
        editModal.style.display = 'none';
    }
}

// Drag and drop reordering (simplified version)
const stepsContainer = document.getElementById('stepsContainer');
let draggedElement = null;

stepsContainer.querySelectorAll('.step-item').forEach(item => {
    item.draggable = true;
    
    item.addEventListener('dragstart', function(e) {
        draggedElement = this;
        this.style.opacity = '0.5';
    });
    
    item.addEventListener('dragend', function(e) {
        this.style.opacity = '';
        updateStepOrders();
    });
    
    item.addEventListener('dragover', function(e) {
        e.preventDefault();
        const draggingAbove = e.clientY < this.getBoundingClientRect().top + this.offsetHeight / 2;
        if (draggingAbove) {
            this.parentNode.insertBefore(draggedElement, this);
        } else {
            this.parentNode.insertBefore(draggedElement, this.nextSibling);
        }
    });
});

function updateStepOrders() {
    const steps = [];
    document.querySelectorAll('.step-item').forEach((item, index) => {
        steps.push({
            id: parseInt(item.dataset.stepId),
            order: index + 1
        });
        item.querySelector('.step-title').textContent = `${index + 1}. ${item.querySelector('.step-title').textContent.split('. ')[1]}`;
    });
    
    fetch('/django-guides/step/reorder/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ steps: steps })
    });
}
</script>
{% endblock %}
